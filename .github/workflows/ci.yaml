name: "CI"
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

permissions:
  checks: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "ğŸ” Run Linter"
        run: |
          tmp_res=$(mktemp)
          tmp_error=$(mktemp)
          uv run pylint agent_researcher.py --fail-under=7 > "$tmp_res" 2> "$tmp_error"

          if [ $? -ne 0 ]; then
            echo "::error::Linting failed: $(cat "$tmp_error")"
            exit 1
          fi
          echo "::info::Linting results: $(cat "$tmp_res")"
  format:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "âœ¨ Run Formatter"
        run: |
          uv run black agent_researcher.py --check ||
            (echo "::error::Formatting failed" && exit 1)

  type-check:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "ğŸ“ Run Type Checker"
        run: |
          uv run mypy agent_researcher.py ||
            (echo "::error::Type checking failed" && exit 1)

  security:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "ğŸ”’ Run Security Checks"
        run: |
          uv run bandit agent_researcher.py ||
            (echo "::error::Security checks failed" && exit 1)

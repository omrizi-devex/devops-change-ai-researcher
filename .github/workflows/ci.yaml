name: "CI"
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

permissions:
  checks: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "ğŸ” Run Linter"
        run: |
          tmp_res=$(mktemp)
          set +e
          uv run pylint agent_researcher.py --fail-under=7 &> "$tmp_res"
          exit_code=$?
          set -e
          
          echo "::group::Linting Output"
          cat "$tmp_res"
          echo "::endgroup::"

          if [ $exit_code -ne 0 ]; then
            echo "::error::Linting failed (exit code: $exit_code)"
            echo "::error::Code quality score is below the required threshold of 7.0"
            exit $exit_code
          fi
  format:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "âœ¨ Run Formatter"
        run: |
          uv run black agent_researcher.py --check ||
            (echo "::error::Formatting failed" && exit 1)

  type-check:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "ğŸ“ Run Type Checker"
        run: |
          uv run mypy agent_researcher.py ||
            (echo "::error::Type checking failed" && exit 1)

  security:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v5

      - name: "ğŸ Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"

      - name: "âš¡ Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "::group::Installing dependencies"
          uv sync
          echo "::endgroup::"

      - name: "ğŸ”’ Run Security Checks"
        run: |
          uv run bandit agent_researcher.py ||
            (echo "::error::Security checks failed" && exit 1)
